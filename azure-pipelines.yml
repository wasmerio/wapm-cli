trigger:
  - master

resources:
  containers:
    - container: rust133
      image: rust:1.33
jobs:
  - job: LinuxContainer
    pool:
      vmImage: 'ubuntu-16.04'
    strategy:
      matrix:
        rust133:
          containerResource: rust133
    container: $[ variables['containerResource'] ]
    steps:
      - script: |
          export PATH=$PATH:$HOME/.cargo/bin
          cargo build --verbose
        displayName: 'Build wapm'
      - script: |
          export PATH=$PATH:$HOME/.cargo/bin
          cargo test --verbose -- --test-threads=1
        displayName: 'Test wapm'
  - job: Windows
    pool:
      vmImage: 'windows-2019'
    steps:
      - powershell: |
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          Invoke-WebRequest "https://win.rustup.rs/x86_64" -OutFile rustup-init.exe -UseBasicParsing
          Start-Process -FilePath 'rustup-init.exe' -ArgumentList '-y', '--default-toolchain', 'stable-x86_64-pc-windows-msvc' -Wait
          Remove-Item .\rustup-init.exe
        displayName: 'install rust'
      - script: |
          set PATH=%PATH%;%USERPROFILE%\.cargo\bin
          cargo -V
          cargo test --verbose -- --test-threads=1
        displayName: 'test wapm'
  - job: e2eRegressionTests
    pool:
      vmImage: 'ubuntu-16.04'
    strategy:
      matrix:
        rust133:
          containerResource: rust133
    container: $[ variables['containerResource'] ]
    steps:
      - script: |
          export PATH=$PATH:$HOME/.cargo/bin
          cargo build --verbose
        displayName: 'Build wapm'
      - script: |
          export PATH=$PATH:$HOME/.cargo/bin
          export WAPM_DISABLE_COLOR=true
          chmod +x end-to-end-tests/install.sh
          ./end-to-end-tests/install.sh > /tmp/install-out.txt
          cat /tmp/install-out.txt
          echo "comparing"
          diff -B end-to-end-tests/install.txt /tmp/install-out.txt
        displayName: 'Install regression test'
